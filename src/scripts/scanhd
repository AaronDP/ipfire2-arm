#!/bin/bash

case "$1" in
	ide)
		/sbin/kudzu -qps -c HD | egrep "desc|device:" | awk -F': ' '{print $2}' | sed -e '/"$/a\\' -e "s/$/\;/g" | tr "\n" "XX" | sed -e "s/XX/\n/g" -e "s/\;X/\;/g" | grep '^"' -v > /var/ipfire/extrahd/scan
		if [ -e /dev/.mdadm ]; then
			echo 'md;"MDADM software-raid";' >> /var/ipfire/extrahd/scan
		fi
		if [ -e /dev/mmcblk0 ]; then
			echo 'mmcblk0;"MMC/SD Cardreader";' >> /var/ipfire/extrahd/scan
		fi
		if [ -e /dev/mmcblk1 ]; then
			echo 'mmcblk1;"MMC/SD Cardreader";' >> /var/ipfire/extrahd/scan
		fi
		;;
	partitions)
		cat /proc/partitions | awk '{print $4 " " $3 }' | grep -v name | grep -v "^[:space:]*$" | \
			while read device size; do
				[ -z "${device}" ] && continue
				echo "${device};${size};$(blkid -c /dev/null -s UUID -o value /dev/${device});"
			done > /var/ipfire/extrahd/partitions
		;;
	*)
		echo "Usage: $0 (ide|partitions)"
		;;
esac
