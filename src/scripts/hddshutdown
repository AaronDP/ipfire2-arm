#!/usr/bin/perl
#
# IPFire HDD Shutdown state reader
#
# This code is distributed under the terms of the GPL
#
# 18.09.2007 Maniacikarus - IPFire.org - maniacikarus@ipfire.org
# 22.09.2007 Arne_F -  fitzenreiter.de - arne@fitzenreiter.de

# begin

my @devices = `kudzu -qps -c HD | grep device: | cut -d" " -f2 | sort | uniq`;
my $diskstats = "";
my $newdiskstats = "";
my $debug = 1;
my $status = "";

if ($debug){print "### Searching for available Disks ###\n";}

foreach (@devices){
    chomp $_;
    $diskstats = `cat /tmp/hddstats-$_`;
    chomp $diskstats;
    $newdiskstats = `iostat -d -t $_ | tail -2 | head -1 | awk '{ print \$5","\$6}'`;
    chomp $newdiskstats;
    $status = `hdparm -C /dev/$_ | tail -1 | cut -d: -f2`;
    chomp $status;

    if ($debug){print "Device ".$_." IDE Power status:".$status."\n";}
    if (-e "/tmp/hddshutdown-$_" && $status !~/standby/)
    {
	if ($debug){print "Remove wrong standby marking\n";}
	if ( -e "/tmp/hddshutdown-$_" ) { system("unlink /tmp/hddshutdown-$_"); } 
    }

    if ($debug){print "Device ".$_." has ".$newdiskstats." write and read Requests, was ".$diskstats." at last run.\n";}
    if ($diskstats eq $newdiskstats && (! -e "/tmp/hddshutdown-$_") )
    {
	if ($debug){print "Setting Device ".$_." to standby ... ";}
	$status = `hdparm -y /dev/$_ 2>&1`;
	chomp $status;
	if ($status !~/failed/) 
	{  
    	    if ($debug){print "OK\n";}
    	    system("touch /tmp/hddshutdown-$_");
	}
	else
	{
	    if ($debug){print "FAIL\n";}         
	}
    }
    if ($diskstats ne $newdiskstats)
    {
	if ($debug){print "Device ".$_." is active.\n";}
	if ( -e "/tmp/hddshutdown-$_" ) { system("unlink /tmp/hddshutdown-$_"); }
    }
    system("echo $newdiskstats > /tmp/hddstats-$_");
}

# end
