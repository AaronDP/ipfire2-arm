#!/bin/bash

PROG="$1"
VER="$2"
PAK_VER="$3"
EXT=ipfire

if [ -f /install/packages/$PROG-$VER-$PAK_VER.tar.gz.empty ]; then

	echo -e "Package already exists."

else

	# Bringing the files to their right place.
	rm -rf /install/packages/package /tmp/* /packagetmp.tar
	mkdir -p  /install/packages/package
	cp -f /usr/src/src/paks/$PROG/{,un}install.sh /install/packages/package
	cp -f /usr/src/src/paks/$PROG/ROOTFILES       /install/packages/package
	cp -f /usr/src/src/paks/$PROG/depends.txt     /install/packages/package
	chmod 755 /install/packages/package/{,un}install.sh

	cd /    && tar --create --directory=/ --files-from=/install/packages/package/ROOTFILES --file=/packagetmp.tar --exclude='#*'
	cd /    && tar -x -C /tmp -f /packagetmp.tar
	           rm -f /packagetmp.tar
	cd /tmp && tar --create --gzip --verbose --file=/install/packages/package/files.tgz *

	cd /    && rm -rf /tmp/*
	cd /install/packages/package && cat ROOTFILES | grep -v "#" > ROOTFILES
	tar cvz ../$PROG-${VER}_$PAK_VER.$EXT files.tgz install.sh uninstall.sh ROOTFILES depends.txt

	cd /install/packages && md5sum $PROG*.$EXT > $PROG-${VER}_$PAK_VER.$EXT.md5
	cd /install/packages && md5sum $PROG*.$EXT >> all-progs.md5
	rm -rf /install/packages/package
	exit 0
fi
