#!/bin/sh
###############################################################################
#                                                                             #
# IPFire.org - A linux based firewall                                         #
# Copyright (C) 2007  Michael Tremer & Christian Schmidt                      #
#                                                                             #
# This program is free software: you can redistribute it and/or modify        #
# it under the terms of the GNU General Public License as published by        #
# the Free Software Foundation, either version 3 of the License, or           #
# (at your option) any later version.                                         #
#                                                                             #
# This program is distributed in the hope that it will be useful,             #
# but WITHOUT ANY WARRANTY; without even the implied warranty of              #
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the               #
# GNU General Public License for more details.                                #
#                                                                             #
# You should have received a copy of the GNU General Public License           #
# along with this program.  If not, see <http://www.gnu.org/licenses/>.       #
#                                                                             #
###############################################################################

. /etc/sysconfig/rc
. $rc_functions

PRIMARY_DNS=$DNS1
SECONDARY_DNS=$DNS2

eval $(/usr/local/bin/readhash /var/ipfire/ppp/settings)

if [ "$DNS" == "Automatic" ]; then
	if [ "$TYPE" == "isdn" ]; then
		echo -n "$MS_DNS1" > /var/ipfire/red/dns1
		echo -n "$MS_DNS2" > /var/ipfire/red/dns2
	else
		echo -n "$PRIMARY_DNS" > /var/ipfire/red/dns1
		echo -n "$SECONDARY_DNS" > /var/ipfire/red/dns2
	fi
else
	echo -n "$DNS1" > /var/ipfire/red/dns1
	echo -n "$DNS2" > /var/ipfire/red/dns2
fi

echo -n "$1" > /var/ipfire/red/iface
echo -n "$4" > /var/ipfire/red/local-ipaddress
echo -n "$5" > /var/ipfire/red/remote-ipaddress

grep -v "gateway" /etc/hosts > /tmp/hosts
echo "$5 gateway" >> /tmp/hosts
touch /var/ipfire/red/active
mv /tmp/hosts /etc/hosts

#Start pingtest in background and store the pid
ping -c 2 $5 > /tmp/gatewayping &
PINGPID=$!

run_subdir ${rc_base}/init.d/networking/red.up/

[ -e "/var/ipfire/ppp/nobeeps" ] || /etc/rc.d/init.d/beep up

#Make sure that pingtest has enough time
sleep 3

#Kill the pingtest
kill $PINGPID >/dev/null 2>&1

#Check if gateway has answerd to ping, if not replace with ping.ipfire.org
TEST=`cat /tmp/gatewayping | tail -2 | head -1 | cut -d"," -f2`;

if [ "$TEST" == " 2 packets received" ]; then
	echo Ping gateway
else
	echo Ping ipfire
	FIRE=`nslookup ping.ipfire.org | tail -2  | head -1 | cut -d" " -f2`;
	grep -v "gateway" /etc/hosts > /tmp/hosts
	echo "$FIRE gateway" >> /tmp/hosts
	mv /tmp/hosts /etc/hosts
fi
rm -f /tmp/gatewayping
