Subject: display last accessed sysfs file on kernel panic message
From: Andrew Morton <akpm@osdl.org>
Patch-mainline: never

Display the most-recently-opened sysfs file's name when oopsing.

From: Adrian Bunk <bunk@stusta.de>

  Build fix

From: Greg Kroah-Hartman <gregkh@suse.de>

  Modified to make the api call cleaner, and available to all arches if
  need be.  Also added it to x86-64's crash dump message.


Signed-off-by: Adrian Bunk <bunk@stusta.de>
Signed-off-by: Andrew Morton <akpm@osdl.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@suse.de>
Automatically created from "patches.drivers/sysfs-crash-debugging.patch" by xen-port-patches.py

--- sle11-2009-08-26.orig/arch/x86/kernel/traps_32-xen.c	2009-06-04 10:21:39.000000000 +0200
+++ sle11-2009-08-26/arch/x86/kernel/traps_32-xen.c	2008-11-25 13:17:06.000000000 +0100
@@ -432,6 +432,8 @@ int __kprobes __die(const char *str, str
 	printk("DEBUG_PAGEALLOC");
 #endif
 	printk("\n");
+
+	sysfs_printk_last_file();
 	if (notify_die(DIE_OOPS, str, regs, err,
 			current->thread.trap_no, SIGSEGV) == NOTIFY_STOP)
 		return 1;
--- sle11-2009-08-26.orig/arch/x86/kernel/traps_64-xen.c	2009-06-04 10:21:39.000000000 +0200
+++ sle11-2009-08-26/arch/x86/kernel/traps_64-xen.c	2008-11-25 13:17:06.000000000 +0100
@@ -539,6 +539,8 @@ int __kprobes __die(const char *str, str
 	printk("DEBUG_PAGEALLOC");
 #endif
 	printk("\n");
+
+	sysfs_printk_last_file();
 	if (notify_die(DIE_OOPS, str, regs, err,
 			current->thread.trap_no, SIGSEGV) == NOTIFY_STOP)
 		return 1;
