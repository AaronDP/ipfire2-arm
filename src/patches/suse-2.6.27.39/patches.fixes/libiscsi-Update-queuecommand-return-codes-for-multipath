From: Hannes Reinecke <hare@suse.de>
Date: Tue, 18 Aug 2009 11:37:41 +0200
Subject: libiscsi: Update queuecommand return codes for multipathing
References: bnc#472432

For multipathing we should be returning DID_TRANSPORT_XXX
messages for any error which should be retried on some other
path. And the 'chkready' function is quite pointless here.

Signed-off-by: Hannes Reinecke <hare@suse.de>
---
 drivers/scsi/libiscsi.c |    9 +++------
 1 files changed, 3 insertions(+), 6 deletions(-)

diff --git a/drivers/scsi/libiscsi.c b/drivers/scsi/libiscsi.c
index 14ba60f..32b30f1 100644
--- a/drivers/scsi/libiscsi.c
+++ b/drivers/scsi/libiscsi.c
@@ -1327,12 +1327,6 @@ int iscsi_queuecommand(struct scsi_cmnd *sc, void (*done)(struct scsi_cmnd *))
 	session = cls_session->dd_data;
 	spin_lock(&session->lock);
 
-	reason = iscsi_session_chkready(cls_session);
-	if (reason) {
-		sc->result = reason;
-		goto fault;
-	}
-
 	if (session->state != ISCSI_STATE_LOGGED_IN) {
 		/*
 		 * to handle the race between when we set the recovery state
@@ -1342,6 +1336,9 @@ int iscsi_queuecommand(struct scsi_cmnd *sc, void (*done)(struct scsi_cmnd *))
 		 */
 		switch (session->state) {
 		case ISCSI_STATE_FAILED:
+			reason = FAILURE_SESSION_FAILED;
+			sc->result = DID_TRANSPORT_DISRUPTED << 16;
+			break;
 		case ISCSI_STATE_IN_RECOVERY:
 			reason = FAILURE_SESSION_IN_RECOVERY;
 			sc->result = DID_IMM_RETRY << 16;
-- 
1.6.0.2

