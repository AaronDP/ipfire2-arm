From: Mikulas Patocka <mpatocka@redhat.com>
Subject: dm: set queue ordered mode
Patch-mainline: 2.6.30
References: bnc#496353
Acked-by: Nikanth Karthikesan <knikanth@suse.de>

commit 99360b4c18f7675b50d283301d46d755affe75fd
Author: Mikulas Patocka <mpatocka@redhat.com>
Date:   Thu Apr 2 19:55:39 2009 +0100

    dm: set queue ordered mode
    
    Set queue ordered mode.  It doesn't really matter what we set here
    because we don't ever put any requests on the queue.  But we need to set
    something other than QUEUE_ORDERED_NONE so that __generic_make_request
    passes barrier requests to us.
    
    Signed-off-by: Mikulas Patocka <mpatocka@redhat.com>
    Signed-off-by: Alasdair G Kergon <agk@redhat.com>

---
 drivers/md/dm.c |    1 +
 1 file changed, 1 insertion(+)

--- a/drivers/md/dm.c
+++ b/drivers/md/dm.c
@@ -1801,6 +1801,7 @@ static struct mapped_device *alloc_dev(i
 	md->queue->backing_dev_info.congested_fn = dm_any_congested;
 	md->queue->backing_dev_info.congested_data = md;
 	blk_queue_make_request(md->queue, dm_request);
+	blk_queue_ordered(md->queue, QUEUE_ORDERED_DRAIN, NULL);
 	blk_queue_bounce_limit(md->queue, BLK_BOUNCE_ANY);
 	md->queue->unplug_fn = dm_unplug_all;
 	blk_queue_merge_bvec(md->queue, dm_merge_bvec);
