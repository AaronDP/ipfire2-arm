From 89130d91d684faa88cb244f46c85eb26a8c06d7a Mon Sep 17 00:00:00 2001
From: Simon Kelley <simon@thekelleys.org.uk>
Date: Wed, 3 Jun 2015 22:30:59 +0100
Subject: [PATCH 102/113] DHCPv6: DHCPCONFIRM should be OK for any address on
 link, not just dynamic addresses.

---
 CHANGELOG     | 5 +++++
 src/rfc3315.c | 2 +-
 2 files changed, 6 insertions(+), 1 deletion(-)

diff --git a/CHANGELOG b/CHANGELOG
index ef39a415788b..9e1b5a5ab0b8 100644
--- a/CHANGELOG
+++ b/CHANGELOG
@@ -121,6 +121,11 @@ version 2.73
 	    Allow DHCPv4 options T1 and T2 to be set using --dhcp-option.
 	    Thanks to Kevin Benton for patches and work on this.
 
+            Fix code for DHCPCONFIRM DHCPv6 messages to confirm addresses
+	    in the correct subnet, even of not in dynamic address 
+	    allocation range. Thanks to Steve Hirsch for spotting
+	    the problem.
+	
 	
 version 2.72
             Add ra-advrouter mode, for RFC-3775 mobile IPv6 support.
diff --git a/src/rfc3315.c b/src/rfc3315.c
index b4f5dd2db61f..2665d0d3294a 100644
--- a/src/rfc3315.c
+++ b/src/rfc3315.c
@@ -1089,7 +1089,7 @@ static int dhcp6_no_relay(struct state *state, int msg_type, void *inbuff, size_
 	      {
 		struct in6_addr *req_addr = opt6_ptr(ia_option, 0);
 		
-		if (!address6_available(state->context, req_addr, tagif, 1))
+		if (!address6_valid(state->context, req_addr, tagif, 1))
 		  {
 		    o1 = new_opt6(OPTION6_STATUS_CODE);
 		    put_opt6_short(DHCP6NOTONLINK);
-- 
2.1.0

