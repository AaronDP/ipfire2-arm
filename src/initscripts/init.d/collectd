#!/bin/sh
# Begin $rc_base/init.d/collecd


. /etc/sysconfig/rc
. $rc_functions

eval $(/usr/local/bin/readhash /var/ipfire/main/settings)

if [ "$RRDLOG" = '' ]; then
	RRDLOG=/var/log/rrd
fi

case "$1" in
	start)
		# At first run search for sensors with sensors-detect
		if [ ! -e /etc/sysconfig/lm_sensors ]; then
			boot_mesg "Searching for Sensors..."

			# First scan
			"yes" | /usr/sbin/sensors-detect > /dev/null

			# Module load
			for modul in `cat /etc/sysconfig/lm_sensors | grep '^MODULE_' | cut -d"=" -s -f2`; do
			    modprobe $modul > /dev/null 2>&1;
			done

			# Second scan
			"yes" | /usr/sbin/sensors-detect > /dev/null
			evaluate_retval

			if [ ! -e /etc/sysconfig/lm_sensors ]; then
				echo "#No Sensors detected " > /etc/sysconfig/lm_sensors
			fi
		fi

		boot_mesg -n "Loading Sensor Modules..."
		for modul in `cat /etc/sysconfig/lm_sensors | grep '^MODULE_' | cut -d"=" -s -f2`; do
		modprobe $modul > /dev/null 2>&1;
			if [ ${?} = 0 ]; then
				boot_mesg -n "$SUCCESS$modul$NORMAL ";
			else
				boot_mesg -n "$FAILURE$modul$NORMAL ";
			fi
		done
		boot_mesg;
		echo_ok;

		# Enable sensors plugin if sensors found
		if [ $( sensors 2>&1 | grep "No sensors found!" | wc -l ) == "1" ]; then
			sed -i -e "s|^LoadPlugin sensors|#LoadPlugin sensors|g" /etc/collectd.conf
		else
			sed -i -e "s|^#LoadPlugin sensors|LoadPlugin sensors|g" /etc/collectd.conf
		fi

		# Enable thermal plugin if thermal_zone found
		if [ ! -e  /sys/class/thermal/thermal_zone0 ]; then
			sed -i -e "s|^LoadPlugin thermal|#LoadPlugin thermal|g" /etc/collectd.conf
		else
			sed -i -e "s|^#LoadPlugin thermal|LoadPlugin thermal|g" /etc/collectd.conf
		fi

		# Enable swap plugin if swap found
		if [ "$(swapon -s | wc -l)" == "1" ]; then
			sed -i -e "s|^LoadPlugin swap|#LoadPlugin swap|g" /etc/collectd.conf
		else
			sed -i -e "s|^#LoadPlugin swap|LoadPlugin swap|g" /etc/collectd.conf
		fi

		boot_mesg "Starting Collection daemon..."
		/usr/sbin/collectd -C /etc/collectd.conf
		evaluate_retval
		;;
	stop)
		# Save the ramdisk at manual stop but not at shutdown
		if [ "$(basename $0)" == "collectd" ]; then
		    /etc/init.d/tmpfs backup
		fi
		boot_mesg "Stopping Collection daemon..."
		killproc /usr/sbin/collectd
		evaluate_retval
		;;
	restart)
		${0} stop
		sleep 1
		${0} start
		;;
	status)
		statusproc /usr/sbin/collectd
		;;

	*)
		echo "Usage: $0 {start|stop|restart|status}"
		exit 1
		;;
esac

# End $rc_base/init.d/collectd
